% =================================================================================================
% Holodeck Methods Paper - Manuscript
% -----------------------------------
%
%
%
% =================================================================================================

% =================================================================================================
% ====   Header & Setup
% =================================================================================================
\documentclass[useAMS, usenatbib]{mnras}

% general package imports and setup
\input{src/packages}
% definitions of custom commands
\input{src/commands}
% journal abbreviations for bibliography
\input{src/abbrevs}

% =================================================================================================
% ====    Front Matter
% =================================================================================================

% \newtotcounter{citnum} % From the package documentation
% \def\oldbibitem{} \let\oldbibitem=\bibitem
% \def\bibitem{\stepcounter{citnum}\oldbibitem}

% \newcommand{\orcidauthorA}{0000-0002-6625-6450} % For author A

\title[holodeck: MBH binary populations]{Enter the \texttt{holodeck}: massive black hole binary population synthesis for gravitational wave calculations}
\author[NANOGrav]{the NANOGrav collaboration}



\begin{document}

\maketitle

\begin{abstract}
    abstract
\end{abstract}

\begin{keywords}
    quasars: supermassive black holes
\end{keywords}




% =================================================================================================
% ====    Section 1 - Introduction
% =================================================================================================

\begin{itemize}
    \item Change $f_r \rightarrow f$
    \item holodeck uses $f_\trt{obs}$ as grid variable, not $f_r$, mesh this with the analytic formalism and description
\end{itemize}


\section{Introduction}
    \label{sec:intro}

    Massive black holes (MBHs) occupy the centers of most if not all massive galaxies \needcite{}.
    Binaries of MBHs are believed to form following the merger of massive galaxies \needcite{}.  Such MBH Binaries (MBHBs) could then produce low-frequency gravitational waves (GWs) \needcite{LF-GWs}, in the nano-Hertz regime, that would soon be detectable by experiments called pulsar timing arrays (PTAs) \needcite{PTAs}.  In this paper, we introduce the MBHB population synthesis code called \holodeck{}.  The goal of this package is to provide a cohesive and comprehensive framework for:
    % Massive black holes (MBHs) are known to occupy the centers of most if not all massive galaxies \needcite{}.
    Binaries of MBHs form following the merger of massive galaxies \needcite{}.  These MBH Binaries (MBHBs) can then produce the loudest gravitational waves (GWs) in the Universe.  MBHBs with total masses $M \gtrsim 10^8 \,\msol$ are detectable by experiments called pulsar timing arrays (PTAs) \needcite{PTAs} in the nanohertz regime \needcite{}, while more modest systems with $M \lesssim 10^7 \, \msol$ will be detectable by LISA \needcite{LISA} at millihertz \needcite{}.  While accreting, MBHs are visible across the electromagnetic (EM) spectrum as active galactic nuclei (AGN) \needcite{}, suggesting that MBHBs could be promising multimessenger sources \needcite{}.  A large number of studies have modeled cosmological populations of MBHBs, and made predictions for their GW signatures and EM counterparts, however no comprehensive framework has been released.  In this paper, we introduce the MBHB population synthesis code \holodeck{}, developed within the astrophysics working group of the NANOGrav\footnote{North American nanohertz observatory for gravitational waves \citep{}: \url{https://www.nanograv.org}.}.  The goal of this package is to provide a cohesive and comprehensive framework for:
    \begin{enumerate}
        \item
        modeling the physics of MBHB formation and evolution, with parameterizations for uncertain physical processes;
        \item
        rapidly generating large simulated populations of MBHBs; and,
        \item
        calculating the resulting GW signals and EM signatures from these populations.
    \end{enumerate}
    % (1) modeling the physics of MBHB formation and evolution while accurately capturing the true uncertainties in this modeling, (2) rapidly generating large simulated populations of MBHBs, and (3) calculating the resulting GW signals from these populations.

    As in the case of high-frequency GWs detected by LIGO-Virgo \needcite{}, tremendous uncertainties exist in the physics of the formation and evolution of the binary sources.  For individual MBHs, there are numerous, well-known scaling relationships between their properties and those of their host galaxies \needcite{MBH-Host relations}, but numerous questions remain such as where or not the observed sample of MBHs (i.e.~quasars and active galactic nuclei, AGN) accurately reflect the full population \needcite{MBH bias}, and how reliably these relationships extend to different host galaxies and redshift ranges.

    For binary MBHs in particular, a variety of physical processes are required for the two MBHs to find the center of the post-merger host galaxy and eventually become gravitationally bound \needcite{BBR1980}.  In particular, the two MBHs must interact with their host galaxy environments through dynamical friction, stellar scattering, accretion disk torques, and possibly three-body interactions with a third MBH component \needcite{}, before reaching small enough binary separations for GW emission to eventually dominate the final coalescence of the binary.  Besides GW emission, none of these processes can be modeled exactly, necessitating the usage of simplified prescriptions which each containing numerous parametric uncertainties.  The resolution of cosmological hydrodynamic simulations is far too coarse to resolve the MBH binary phase, with some simulations instantaneously merging nearby MBHs \needcite{illustris}, and others using sub-grid models to `resolve' down to the scale of $\sim kpc$ \needcite{Romulus/Tremmel, Ma+Hopkins}.

    In addition to the theoretical uncertainties, there exists a substantial dearth of observational constraints.  A growing number of \textit{candidate} MBHB systems have been identified through varying electromagnetic (EM) indicators in AGN \needcite{}, but a substantial fraction may be false positives \needcite{}.  To date, no gravitationally bound MBH binary has yet to be confirmed, although examples exist of dual AGN at close projected separation \needcite{Rodriguez et al. 2007}, and single AGN showing time-variability highly suggestive of a binary companion \needcite{OJ~287}.

    GWs from MBHBs, particularly in the form of a stochastic gravitational wave background (GWB), have been forecast for decades.  Only recently have the sensitivities of PTA experiments begin to encroach on astrophysically plausible GWB amplitudes \needcite{PTA limits} \needcite{c.f.~Shannon et al.}.  Indeed, PTA upper-limits have already been used to place constraints on limited sub-spaces of MBHB parameters \needcite{11yr analysis, etc}.  In the 12.5yr dataset of the North-American nano-Hertz Observatory for Gravitational waves \needcite{NANOGrav}, a `common process' signal was identified that is consistent with a GWB but not yet statistically definitive.  Followup modelling suggests that the GW nature of the signal can be determined within the next few years \needcite{Pol}.  While the interpretation is currently entirely conjectural, the two currently measurable parameters of the common process, the GW-strain amplitude and strain spectral index, each challenge the standard expectations of theoretical models.  The \todo{possible} amplitude is larger than many models have predicted, and the spectral index significantly flatter than the canonical `-2/3' power-law \needcite{phinney} \needcite{c.f.~Sesana, Kocsis}.  Still, both of these parameters can easily be fit with current models, and indeed, studies have already performed MBHB model inference using the amplitude and spectral index of the candidate \todo{(what's the word besides `candidate'?)} signal \needcite{middleton}.

    Studies which have used PTA observations to constrain MBHB models have been focused on demonstrating the feasibility of performing such inference, and thus have relied on single classes of models (semi-analytic models, SAMs) that make significant simplifications of the physical processes, and only explore small sub-spaces of astrophysical parameters.  The \holodeck{} framework, presented here, is structured to more fully capture the astrophysical uncertainties underlying our understanding of MBHB formation and evolution.  \holodeck{} uses comprehensive and self-consistent models for binary evolution, in addition to allowing SAMs to be interchanged with populations derived from cosmological hydrodynamic simulations.  In this way, \holodeck{} is designed to capture both statistical and systematic uncertainties by allowing the marginalization over not only specific astrophysical parameters, but also entire modeling methodologies.

    Tremendous uncertainties exist across every stage of the formation and evolution MBHBs.  Even the formation process(es) of individual MBHs is almost entirely unconstrained \needcite{}.  The three leading seeding mechanisms---light seeds: the rapid growth of stellar mass black holes, heavy seeds: from the `direct collapse' of pristine gas clouds, or in between: the runaway mergers of stars or stellar remnants in dense clusters---all struggle to explain the high masses and high occurrence rates of quasars in the very early Universe \needcite{}.  LISA, scheduled to be launched in the mid 2030s, can directly detect MBHBs at their seeding mass and redshift \needcite{}.  Accurate models for LISA sources are required to translate GW detections (or the lack of detections) into meaningful astrophysical constraints.

    PTA sources, the most massive MBHBs in the relatively local Universe, are not particularly sensitive to seeding model, as the early history of their formation is washed out \needcite{}.  For a given seeding model to be viable, it must be able to reproduce the properties of well characterized MBHs and AGN in the local Universe \needcite{}.  For nearby systems, numerous, well-known scaling relations connect the properties of MBHs to their host galaxies \needcite{MBH-Host relations}.  Even then, questions remain such as whether or not the observed sample of MBHs, i.e.~luminous ones, accurately reflect the full population \needcite{MBH bias}, and how reliably these relationships extend to different mass and redshift ranges, and differences in host galaxy type.

    The properties and occurrence rates of MBH binaries are almost entirely unconstrained, as no confirmed examples of gravitationally bound MBHBs exist.  A large number of \textit{dual} systems, not dynamically interacting, have been identified---typically at kiloparsec separations \needcite{dual AGN}, but one example which may be within the sphere of influence \needcite{Rogriguez et al.}.  Additionally, many \textit{candidate} binaries have been suggested in the literature \needcite{Graham, Charisi}, however, numerous lines of reasoning suggest that many or most are likely false positives \needcite{Eracleous, Sesana, Kelley}.  Still, handful of compelling examples persist \needcite{OJ287, etc?  BoBCat?}.

    Despite the lack of observational constraints, the evolution of MBHBs has been explored for decades.  Following galaxy merger, a variety of physical processes are required for the two MBHs to find the center of the post-merger host galaxy and eventually become gravitationally bound \needcite{BBR1980}.  In particular, the two MBHs must interact with their host galaxy environments through dynamical friction ($\sim\Kpc$) and stellar scattering ($\sim \pc$), and possibly a circumbinary accretion disk ($\lesssim \pc$), possibly triply interactions with a third MBH component ($\sim \pc$) \needcite{Loeb, Ryu, Bonetti}.  Only after these interactions can binaries reach the separations where GW emission will become important, and drive their final coalescence.  A lower-limit to binary lifetimes can be estimates by assuming that environmental processes are highly efficient at extracting energy and angular momentum from the two MBHs, in which case their separation could e-fold roughly every dynamical time, leading to total binary lifetimes of $\sim 100 \Myr$.

    On the other extreme, there is no physical necessity for environmental interactions to be effective, and all binaries could stall.  The existence of stable satellite galaxies demonstrates that, at least for small mass-ratio galaxy mergers ($q \equiv m_2/m_1 \leq 1$), dynamical friction is not always effective.  The stellar scattering regime is typically believed to be the most challenging for inspiral.  In general, roughly a mass of stars equivalent to that of the secondary MBH must be scattered for each e-folding of binary separation.  Analytic estimates, using symmetric phase-space distributions of stars that are able to interact with the binary (the `loss cone'), typically find that inspiral would take longer than the Hubble time---the `final-parsec' problem \needcite{Merritt, Milosaljevic}.  More detailed calculations that account for the tumultuous nuclear environments of realistic galaxies, typically find that the loss-cone can be continually refilled and inspiral can be efficient \needcite{}.  Even with a full loss-cone, inspiral can take multiple billions of years, and large fractions of systems can still stall \needcite{Kelley2017}.

    Torques from circumbinary accretion disks have been suggested to aid in the inspiral process at sub-parsec scales \needcite{Cuadra, Haiman, etc}.  Galaxy mergers are known to drive substantial volumes of gas to galactic nuclei \needcite{Hernquist, etc}, but whether this persists long enough for binaries to reach the parsec regime is unclear.  Nuclear bursts of star formation following galaxy mergers may even preferentially drive out the gas in galactic nuclei roughly coincident with when binaries form \needcite{may not be any}.  Even if high mass circumbinary disks form, recent results from idealized hydrodynamic simulations have shown that circumbinary disk toques can actually drive binaries towards out-spiral \needcite{Munoz}.  This is likely not a problem for PTA sources, higher mass MBHBs, both because of the regimes in which out-spiral is expected to dominate \needcite{outspiral population study}, and because high-mass elliptical galaxy mergers tend to be much drier.

    The long inspiral times of MBHBs, particularly in systems which tend towards stalling, can easily become longer than the typical time between galaxy mergers.  This suggests that systems with three MBHs could become important \needcite{Loeb}.  Cosmological simulations have shown that such occurrences can indeed to be somewhat common \needcite{Kelley, Sayeb, Romulus, Astrid}, but they lack the resolution to explore triple interactions in detail.  Semi-analytic modeling has suggested that such triples could drive a substantial fraction of `stalled' systems to merger \needcite{Bonetti, Ryu}.  However, accurately modeling the triple dynamics at the same time as dissipative environmental interactions is very challenging.

    Besides GW emission, none of these processes can be modeled exactly, necessitating the usage of simplified prescriptions which each containing numerous parametric uncertainties.  The resolution of cosmological hydrodynamic simulations is far too coarse to resolve the MBH binary phase, with some simulations instantaneously merging nearby MBHs \needcite{illustris}, and others using sub-grid models to `resolve' down to the scale of $\sim kpc$ \needcite{Romulus/Tremmel, Ma+Hopkins}.



% =================================================================================================
% ====    Section 2 - Methods
% =================================================================================================



\section{Methods}
    \label{sec:meth}

    \subsection{Source Distributions and Gravitational Wave Calculations}

        The GWB spectrum can be calculated by relating the energy-density of GWs in the local Universe to the integrated GW energy produced by sources over all of cosmic time \citet{Phinney-2001},
        \begin{equation}
            \label{eq:soltan_analog}
            \hc^2(\fobs) = \frac{4G}{\pi c^2 \fobs} \int dz \; \diffp{\ndens}{{z}} \, \diffp{\egw}{{f_r}} \bigg|_{\frst=\fobs\lr{1+z}}.
        \end{equation}
        Converting from the rest-frame frequency $\frst$ to observer-frame $\fobs$ in front of the integral cancels out the redshifting of gravitons between their emission and detection.  Here the comoving, volumetric number density of sources is \mbox{$\ndens \equiv \diffp{N}{{V_c}}$}, and the GWB spectrum is described in terms of the characteristic strain $\hc$.  We can convert from the GW energy-spectrum of each source, $\diffp{\egw}{{\frst}}$, to GW spectral strain using Eq.~\ref{eq:gw_energy_spectrum}~\&~\ref{eq:strain_lum}, and rewrite the GWB spectrum as,
        \begin{equation}
            \label{eq:gwb_sa}
            \hc^2(f) = \int_0^\infty \!\! dz \, \sum_n^\infty \diffp{\ndens}{{z}} \, \hsn^2\lr{\frstorb} \cdot 4\pi c \, \distcom^2 \cdot \lr{1+z} \cdot \thardf(\frstorb) \, \bigg|_{\frstorb = \fobs(1+z)/n}.
        \end{equation}
        Here, $\distcom$ is the comoving distance to redshift $z$.  The characteristic strain (left-hand side) \needcite{} is more appropriate for calculating detectability, while the GW spectral strain $\hsn{}$, is directly related to a source's GW luminosity \needcite{} (\eqref{eq:strain_lum}).  The subscript $n$ denotes the frequency harmonic.  Binaries in eccentric orbits emit GWs at all integer harmonics of their orbital frequency ($\frstorb$).  For circular obits, binaries only emit at the $n=2$ harmonic.  Eq.~\ref{eq:gwb_sa} also includes the frequency residence time / hardening time, \mbox{$\thardf \equiv \frstorb / \lr{\partial \frstorb / \partial t}$}.

        In the case of purely GW-driven binary hardening\footnote{i.e.~using Eq.~\ref{eq:gw_hard}~\&~\ref{eq:hard_time}.}, and circular binary orbits\footnote{i.e.~using Eq.~\ref{eq:gw_strain_amp_circ}}, this can be simplified to \citep[][Eq.~11]{Phinney-2001},
        \begin{equation}
            \label{eq:gwb_ideal}
            \hc^2(f) = \frac{4 \pi}{3 c^2} \, \lr[-4/3]{2\pi f} \int_0^\infty \!\! dz \; \frac{d\ndens}{dz}  \, \frac{\lr[5/3]{G \mchirp}}{\lr[1/3]{1+z}}.
        \end{equation}
        This expression motivates the common idealized approximation that,
        \begin{equation}
            \label{eq:char_strain_plaw}
            \hc(\fobs) \approx A_\tr{ref} \cdot \scale[\alpha]{\fobs}{\fref},
        \end{equation}
        and $\alpha \approx -2/3$ for an idealized GWB characteristic strain spectrum\footnote{In terms of timing residual power spectral density, the idealized power-law index is $-13/3$, see Eq.~\ref{eq:psd_char_strain}.}.  The applicability of this approximation is discussed below.

        Instead of assuming an idealized shape of the GWB spectrum, we would like an expression which calculates the instantaneous number of binaries emitting at any arbitrary frequency interval.  We can do this by first relating the comoving number density of sources ($\ndens \equiv dN/dV_c$) to the total number of binaries in the observer's past light cone \citep{Haehnelt-1994}, and then connecting redshift evolution to the time-evolution of binaries over orbital frequency \citep{Jaffe+Backer-2003}.  We can then write \citep{Sesana+2008},
        \begin{equation}
            \label{eq:number_density_to_number_frequency}
            \frac{d\ndens}{dz} = \frac{d^2N}{dz \, dV_c} = \frac{d^2N}{dz \, d\ln f_p} \frac{d \ln f_p}{dt_r} \frac{dt_r}{dz} \frac{dz}{dV_c}.
        \end{equation}
        This is the crucial expression for modeling a full population of evolving binaries.  Plugging \eqref{eq:number_density_to_number_frequency} into \eqref{eq:gwb_sa}\footnote{And utilizing the expressions from Eqs.~\ref{eq:gw_hard},~\ref{eq:hard_time},~\ref{eq:comvol}~\&~\ref{eq:redshift_time},}, we can confirm that the local characteristic strain is indeed the total spectral strain in a logarithmic frequency interval, emitting by all binaries in the observer's past light cone:
        \begin{equation}
            \label{eq:gwb_mc}
                \hc^2(f) = \int dz \sum_n^\infty \frac{d^2 N}{dz \, d\ln f_p} \, \hsn^2(f_p).
        \end{equation}

        While Eq.~\ref{eq:gwb_sa} and Eq.~\ref{eq:gwb_mc} are formally equal, how they are used in practice can produce important differences.  In particular, as pointed out by \citep[][Eq.~6]{Sesana+2008}, `monte-carlo' calculations that explicitly use Eq.~\ref{eq:gwb_mc} encode the intrinsic discreteness of binary sources.  The `semi-analytic' calculation using Eq.~\ref{eq:gwb_sa}, naively implemented, assumes a smooth, continuous distribution of binary sources without taking into account their quantization.  The effect of binary quantization on the GWB is to produce a steeping of the GWB spectrum relative to the idealized power-law \eqref{eq:gwb_ideal}.  The frequency at which this becomes important is model dependent, but typically at \mbox{$f \gtrsim 1 - 10 \, \pyr$}.

    \subsection{Discretization and Cosmic Variance}

        The conversion from a continuous number-density of sources, to a discrete population of binaries is given by \eqref{eq:number_density_to_number_frequency}.  This can also clearly be seen by comparing Eq.~\ref{eq:gwb_mc} with Eq.~\ref{eq:gwb_sa}, to identify:
        \begin{equation}
            \label{eq:pop_discrete_from_continuous}
            \frac{d^2 N}{dz \, d\ln\!f_p} =
                \frac{d \ndens}{dz} \, 4\pi c \, d_c^2 \lr{1+z} \, \thardf(f_p).
        \end{equation}
        In general, implementations of binary populations will utilize some fixed number of binaries in a finite simulation volume; or alternatively be described as a number density over a finite grid, e.g., total mass, mass ratio, redshift, and orbital frequency.  In the latter case the derivative over redshift in \eqref{eq:pop_discrete_from_continuous} should be replaced with one over all parameters of interest, i.e.~\mbox{$d\ndens / dz \rightarrow d^3\ndens / dM \, dq \, dz$}.  In either case, we will procedurally always be calculating the left-hand side of \eqref{eq:pop_discrete_from_continuous} from the right-hand side.
            \todo{Introduce 'discrete' vs. 'continuous' terminology and SAMs??}

        We will often be interested in quantities which depend on the number of binaries over ranges of parameter space.  For example, for the GWB in the PTA, we are interested in the number of binaries over finite width frequency bins, $\deltalnf = \Delta \ln\!\frstorb$.  These quantities will be calculated using some numerical integration procedure, for example, in the simplest case a Riemann sum: \mbox{$\langle \Delta N \rangle \approx \lr{d^2 N / dz \, d\ln\!f_p} \, \cdot \Delta z \cdot \Delta \ln\!f_p$}.  For distributions calculated over grids with additional parameters, those will also need to be `integrated' over (e.g.~including $1/\partial M$, $1/\partial q$, etc. and also $\Delta M$, $\Delta q$, etc.).  We write this with angle-brackets to denote it as an expectation value for two reasons.  First, it does not yet account for the intrinsic discreteness of binaries.  Second, it does not account for random variance from how many binaries happen to exist in a given volume---either physical volume or parameter-space volume.  We address both issues by drawing specific `realizations' of populations.  Assuming that binaries are uniformly and independently\footnote{These assumptions, while likely accurate, are non trivial.  For example, the Poisson assumption requires that correlated large-scale structure (e.g.~galaxy clusters) produces negligible excesses over the physical volumes of interest.} distributed, they are described by a Poisson distribution such that, $\Delta N \in \poisson(\langle \Delta N \rangle)$.

        For a discretized population of binaries, the GWB spectrum is then calculated as,
        \begin{equation}
            \label{eq:gwb_discrete}
            \hc^2(\Delta \ln f) = \sum_\textrm{bins} \sum_n^\infty \frac{\Delta N(\frstorb,M_a,q_b,z_c,\dots)}{\Delta \ln \frstorb} \, \hsn^2(\frstorb,M_a,q_b,z_c,\dots).
        \end{equation}
        The sum over `bins' corresponds to the bins $a$ in total mass ($M_a$), bins $b$ in mass ratio ($q_b$), etc.
        This is all that is needed for populations calculated from number-density distributions over grids of parameter space, as in the case of semi-analytic models (SAMs) which are described in the following section.

        An additional simplification can be made in the case of discrete binaries in finite volume simulations, such as cosmological hydrodynamic simulations.  The procedure most analogous to that of continuous distributions would be to group discrete binaries into bins of parameter space, calculate a number density, and translate into the number of binaries in the observer's light cone using \eqref{eq:pop_discrete_from_continuous}.  Because a finite range of parameters would still need to be considered before Poisson sampling, this amounts to dividing by and then multiplying by, finite widths of parameter space.  Both steps can be skipped, and instead calculate for each binary ($i$):
        \begin{equation}
            \label{eq:expectation_number_of_single_binary}
            \langle \Delta N \rangle_i = \frac{4\pi c \, \distcom^2 \, \thardf}{V_c} \cdot (1+z_i) \cdot \Delta \ln \frstorb.
        \end{equation}
        In this case, $\thardf$ and $\hsn$ are the hardening time and strain amplitude for each source, and $\langle \Delta N \rangle_i$ represents the expectation number of binaries in the Universe implied by each source in the finite volume.
        \todo{Is this a biased estimator?  I don't think so; the maximum likelihood estimator of a Poisson distribution (i.e. the average over the samples, even if n samples is one) is unbiased.}


    \subsection{Semi-Analytic Modeling}

        We start by defining the distribution function of sources as a volumetric number density such that,
        \begin{equation}
            F(M,q,z,a) = \diffp{n(M,q,z,a)}{{M}{q}}.
        \end{equation}
        Here, $M = m_1 + m_2$ is the total mass of each systems, the mass-ratio is $q\equiv m_2/m_1 \leq 1$, $z$ is the redshift, and $a$ is the binary separation.  Note that we are using the term `binary' to include `pairs' of MBHs at large separations ($a \gg 1 \, \pc$), in addition to true gravitationally-bound systems ($a \lesssim 10s \pc$).  We can write the conservation equation for binaries over redshift as,
        \begin{equation}
            \label{eq:conservation}
            \diffp{F}{z} +
                \diffp{}{M} \lrs{F \diffp{M}{z}} +
                \diffp{}{q} \lrs{F \diffp{q}{z}} +
                \diffp{}{a} \lrs{F \diffp{a}{z}} = S_{\!F}(M,q,z,a).
        \end{equation}
        Here $S_{\!F}$ is a source/sink function that can account for the creation or destruction of binaries.

        In the standard implementations of semi-analytic models (SAMs) for MBH binaries \citep{Rajagopal+Romani-1995, Jaffe+Backer-2003, Sesana+2008, Chen+2019}, $F$ is determined in a region of parameter space that can be observed/estimated, and this is evolved to find the distribution in a different region of parameter space that is of interest.  In practice, the observed parameter space is galaxies and galaxy mergers, and the parameter space of interest is closely separated MBH binaries that could be GW detectable.  We assume that in between these two parts of parameter space there is no additional creation or destruction of binaries, and we set $S_{\!F} = 0$.

        From $\eqref{eq:conservation}$, we use the chain rule to mix time and redshift evolution (where $z = z(t)$), and assume that the mass-change of binaries is negligible, i.e.~$\diffp{m}{t} = 0$ and $\diffp{q}{t} = 0$, giving:
        \begin{equation}
            \label{eq:conservation_fixed_mass}
            \diffp{F}{z} = - \diffp{t}{z} \diffp{}{a} \lrs{F \diffp{a}{t}}.
        \end{equation}
        At this point the binary population is assumed to be changing only in separation and redshift, which are related by \mbox{$\partial a / \partial z = (\partial a / \partial t) (\partial t / \partial z)$}.

        We consider two different SAM parameterizations, one in terms of a galaxy merger rate (GMR, $R_g$), and another in terms of a galaxy pair fraction (GPF, $P_g$) and galaxy merger time (GMT, $T_g$), such that $R_g \approx F_g/T_g$.  In the former case, we consider the GMR as a flux: the rate at which galaxy pairs reach a given part of parameter space, $R_g = R_g(m_1,q,z,a)$.  Because we are assuming masses to be fixed, this amounts to pairs of a given mass, mass-ratio, and redshift reaching a certain separation.  We have written the GMR as a function of the primary mass $m_1$ because this is typically more analogous to parameterizations derived from either observations or simulations, but any pair of $M,q$ can be mapped to a corresponding $m_1,q$.  We additionally introduce the galaxy mass function as the number-density of individual galaxies,
        \begin{equation}
            \Phi(m_1,z) \equiv \diffp{n(m_1,z)}{{m_1}},
        \end{equation}
        which allows us to rewrite \eqref{eq:conservation_fixed_mass} as,
        \begin{equation}
            \label{eq:sam_gmr}
            \diffp{F}{z} = \diffp{n}{{M}{q}{z}} = - \diffp{t}{z} \, \Phi(m_1,z) \, R(m_1,q,z,a).
        \end{equation}

        Galaxy merger rates are particularly convenient when using finite-volume cosmological simulations \citep[e.g.][]{Lacey+Cole-1993}.  In this case, an ensemble of galaxies (or dark matter halos) can be tracked, and the merger rate calculated from the number of mergers divided by the time span.  This amounts to marginalizing over the separations, i.e.~~\mbox{$R_g = \int_{a_1}^{a_2} R_g(a) \, da$}.  From observational data, specific galaxies cannot be tracked over time, and instead the occurrence rate of galaxy pairs is much more natural.  This motivates expressing the distribution function of pairs as a product of the number density of singles (i.e.~mass function) with a pair fraction,
        \begin{equation}
            \label{eq:dist_func}
            F(M,q,z,a) = \Phi(m_1, z) \cdot P(m_1,q,z,a) \big|_{M=m_1(1+q)},
        \end{equation}
        \begin{equation}
            \label{eq:pair_frac}
            P(m_1,q,z) \equiv \diffp{}{q} \lrs{\frac{N_\tr{galaxy-pairs}(m_1,q,z)}{N_\tr{galaxies}(m_1,z)}}.
        \end{equation}
        It's important to note that the observational identification of pairs is both challenging and subtle \needcite{}.  In a given survey, pairs can only be robustly associated with each other within some maximum separation, and they will only be distinguishable above some minimum separation.  The GPF is often marginalized over this range of separations \citep[e.g.][]{Chen+2019}, i.e.~\mbox{$P_g = \int_{a_1}^{a_2} P(a) \, da$}.  Due to these constraints, the pair fraction is typically not meaningful by itself and needs to be compared to a characteristic timescale over which the pairs would be observable.

        The number-density of binaries is conserved, which allows us to take finite steps in separation and time/redshift without approximation: $a\rightarrow a'$ and $z\rightarrow z'$.  The time it takes for a binary to go between separations $a_1 \rightarrow a_2$ is
        % \mbox{$T \equiv \int_{a_1}^{a_2} \frac{da}{\partial a / \partial t}$}.
        \mbox{$T \equiv \int_{a_1}^{a_2} da / \lr{\partial a / \partial t}$}.
        This leads to a redshift at the later time of $z' = z'(t + T)$.  This allows us to approximate the term from \eqref{eq:conservation_fixed_mass} as,
        \begin{equation}
            \label{eq:}
            \diffp{}{a} \lrs{F(M,q,z,a) \diffp{a}{t}} \approx \frac{F(M,q,z,a)}{T_g(m_1,q,z)}.
        \end{equation}`'
        The approximation is tied to the marginalization over binary separation in the GMT term.  Because the number density of binaries $n$ is not explicitly dependent on the separation, we can still write exactly that
        \begin{equation}
            \label{eq:sam_gpf_fmt}
            \diffp{n}{{M}{q}{z'}} = - \diffp{t}{z} \frac{\Phi_g(m_1,z) \, P_g(m_1,q,z)}{T_g(m_1,q,z)}.
        \end{equation}
        Putting this all together, we can write our SAM number of binaries as either,
        \begin{equation}
            \begin{split}
                \label{eq:sam_final_gmr}
                \diffp{N}{{M}{q}{z'}{\ln \! f_r}} & = \Phi_g(m_1,z) \, R_g(m_1,q,z) \, \thardf(M,q,z',f) \, \diffp{{V_c}}{{z'}}, \\
                & = \Phi_g(m_1,z) \, \frac{P_g(m_1,q,z)}{T_g(m_1,q,z)} \, \thardf(M,q,z',f) \, \diffp{V_c}{{z'}}.
            \end{split}
        \end{equation}
        \todo{Should $R_g$ use $z$ or $z'$ (redshift-prime)?}


    % \subsection{Finite Volume Populations: the Illustris simulations}
    %     \todo{Describe illustris models.}



\section{Implementation}
    \label{sec:imp}

    The \holodeck{} framework is written primarily in \python{} using a class-based structure for modularity and extensibility.

    \subsection{Semi-Analytic Models}
        \label{sec:imp_sam}

        The core of the semi-analytic modeling framework in \holodeck{} is implementing \eqref{eq:sam_final}.  There are classes for each of the key components: The galaxy stellar-mass function (GSMF, $\Phi$), the galaxy pair fraction \(F\), the merger timescale ($\tau$), and additional a scaling relation for mapping host galaxies via to MBH properties --- typically via an \mmbulge{} relation.  Each component class is implemented generically via basic API methods (e.g.~a GSMF that returns the number density of galaxies at a given stellar-mass and redshift), and can be subclassed to provide a particular implementation (e.g.~an analytic Schechter-function GSMF).  The number (or number density) of binaries is specified over a grid of parameters, typically in a four dimensional space of total mass ($M$), mass ratio ($q$), redshift ($z$), and binary rest-frame orbital frequency ($f_r$).

        The semi-analytic model formalism defines a continuous distribution of MBH binaries.  For many calculations, the discrete nature of MBHB sources is important, not only for examining individual continuous wave sources but also because of the important effects of discrete sources on the shape of the GWB due to the non-linear scaling of GW strain \citep{Sesana+2008}.  Additional, a component of the uncertainty in expected GW signals is due to `cosmic variance', which can be treated as Poisson noise when creating multiple samples (or `realizations') of our binary populations.  To handle discretization and resampling we use the \texttt{kalepy} package \citep{kalepy2021}, in particular, a method of outlier sampling to capture regions of parameter space where finite number effects are important.  The \holodeck{} semi-analytic models specify the number (or number-density) of binaries over a grid, i.e.~$N_{ijkl}$.  By definition, grid cells which have an expected total number of binaries $\gg 1$ will not produce appreciable finite-number effects, so instead they are given a weighting based on a Poisson distribution centered around their expectation value, i.e.~$\mathcal{P}(N_{ijkl})$.  Grid cells with expected numbers of order unity or less do produce important finite-number effects, and thus are directly resampled

        \subsubsection{Parameters}

            \begin{itemize}
                \item \textbf{GSMF}
                \begin{itemize}
                    \item \citep{Tomczak+2014} - single schechter fits, little variation over redshift\\
                    \item two
                \end{itemize}


                \item \textbf{GPF}
                \begin{itemize}
                    \item one \\
                    \item two
                \end{itemize}


            \end{itemize}



% =================================================================================================
% ====    Section 3 - Results
% =================================================================================================



\section{Results}
    \label{sec:res}

    % Fig -
    % \begin{figure*}
    %     \centering
    %     \includegraphics[width=1.5\columnwidth]{{{figs/det-nums_fedd-1.00_voff+3.00_dvel+2.00_tobs+0.70}}}
    %     \caption{\textbf{Distributions of parameters for all binaries (black) and those with a detectable kinematic signature in the secondary AGN (colors).}  Less than $10^{-7}$ of primaries are observable, which are not shown.  Secondary AGN with observable velocity offsets ($\voff$) are shown in blue assuming a sensitivity of \mbox{$\voffsens = 10^3 \kmps$}.  Secondaries with observable changing velocities ($\dvel$) are shown in orange (solid) for a sensitivity $\dvelsens = 10^2 \kmps$, and observing baseline of \mbox{$\tobs = 5\, \yr$}.  Systems where both offsets and changes are detectable (orange, dotted) are mostly a uniform subset of the $\dvel$ sample, and are almost indistinguishable in the 2D contour plots.  An optical flux cutoff of \mbox{$6\E{-14} \mathrm{erg/s/cm}^2$} (AB Mag $\approx 21$) is also imposed, where all AGN are assumed to be accreting at an Eddington fraction of $0.1$.}
    %     \label{fig:det_bins_num}
    % \end{figure*}



% =================================================================================================
% ====    Section 4 - Conclusions
% =================================================================================================



\section{Discussion \& Conclusions}
    \label{sec:disc}



% =================================================================================================
% ====    End Matter
% =================================================================================================


% ====    Acknowledgments



\section*{Acknowledgments}
	I am very thankful to.

    This research made use of \texttt{astropy}, a community-developed core Python package for Astronomy \citep{astropy2013}, in addition to \texttt{Scipy}~\citep{scipy}, \texttt{ipython}~\citep{ipython}, \texttt{jupyter}~notebook~\citep{jupyter}, \texttt{Numpy}~\citep{numpy2011} \& \texttt{SymPy}~\citep{sympy2017}.  All figures were generated using \texttt{matplotlib}~\citep{matplotlib2007}.  Kernel density estimation was performed using the \texttt{kalepy}{} package (\href{https://github.com/lzkelley/kalepy}{github.com/lzkelley/kalepy}) \citep{kalepy2021}.

    The Illustris data is available online at \href{https://www.illustris-project.org/}{www.illustris-project.org} \citep{Nelson+2015}, and Illustris-TNG data at \href{https://www.tng-project.org/}{www.tng-project.org} \citep{Nelson+2019}.


% ====    Bibliography

\let\oldUrl\url
\renewcommand{\url}[1]{\href{#1}{Link}}

\quad{}
\bibliographystyle{mnras}
\bibliography{src/refs}

\onecolumn
\clearpage


% ====    Appendices

\appendix



\section{Additional Equations}
    \label{sec:app_eqs}

    \subsection{Binaries and Gravitational Waves}

        A binary is described by its total mass $M$, mass ratio $q \equiv m_2 / m_1$ (s.t.~$q\leq1$), (proper) semi-major axis $a$, and rest-frame orbital frequency $f_p$.  The characteristic gravitational wave mass is the chirp mass, $\mchirp \equiv M \, q^{3/5} \, \lr[-6/5]{1+q}$.

        The time evolution of a binary's orbit due to the loss of energy and angular momentum through gravitational waves was calculated by \citep[][Eq.~5.6--5.8]{Peters1964}:
        \begin{subequations}
        \label{eq:gw_hard}
        \begin{align}
            \frac{da}{dt} = & -\frac{64 \, G^3}{5 \, c^5} \frac{M_1 \, M_2 \, M}{a^3} F(e), \\
            \frac{de}{dt} = & -\frac{304 \, G^3}{15 \, c^5} \frac{M_1 \, M_2 \, M}{a^4} \lr{e + \frac{121}{304}e^3},
        \end{align}
        \end{subequations}
        where the GW eccentricity function is,
        \begin{equation}
            \label{eq:ecc_func}
            F(e) \equiv \frac{1 + \frac{73}{24} e^2 + \frac{37}{96} e^4}{\left( 1 - e^2\right)^{7/2}}.
        \end{equation}
        We define the binary `hardening' timescale with respect to frequency, instead of separation, as:
        \begin{equation}
            \label{eq:hard_time}
            \thard \equiv dt/d\ln \frst = \frst / (d\frst/dt) = - \frac{2}{3} a / (da/dt).
        \end{equation}
        In general, the hardening rate can be driven by other mechanisms in addition to gravitational wave emission.

        GW power is emitted at integer harmonics of the orbital frequency, $\frstn = n \cdot \frstorb$, which is also redshifted to reach the observer-frame, $\fobsn = n \cdot \frstorb / (1+z)$.  The energy spectrum emitted in GWs is \citet[][Eq.~3.10]{enoki2007a},
        \begin{subequations}
        \label{eq:gw_energy_spectrum}
        \begin{align}
            \frac{d \egw}{d \frst} & = \int \frac{dt_r}{df_p} \, \sum_{n=1}^\infty \, \lgwn(f_p) \; \delta(\frst - n f_p) \; d f_p \\
                & = \sum_{n=1}^\infty \left[ \lgwn(f_p) \cdot \frac{\thard(f_p)}{n f_p} \right]_{f_p = \frst/n},
        \end{align}
        \end{subequations}
        where the power-radiated at each harmonic can be expressed as is \citep[][Eq.~2.2]{enoki2007a},
        \begin{subequations}
        \begin{align}
            \label{eq:lum_gw}
            \lgw & = \sum_n \lgwn = \lgwc \sum_n g(n,e) = \lgwc \cdot F(e), \\
            \lgwc & = \frac{32}{5 G c^5} \left(G\mchirp\right)^{10/3} \left( 2\pi \frstorb \right)^{10/3}.
        \end{align}
        \end{subequations}
        Here, the GW frequency distribution function is,
        \begin{equation}
        \begin{split}
            \label{eq:freq_dist_func}
            g(n,e) \equiv \frac{n^4}{32} \Biggl(& \left[ J_{n-2}(ne) - 2eJ_{n-1}(ne) + \frac{2}{n} J_n (ne) + 2e J_{n+1} (ne) - J_{n+2} (ne) \vphantom{\frac{2}{n}}\right]^2 \\
            &+ \left(1-e^2\right) \Bigl[J_{n-2}(ne) - 2eJ_n(ne) + J_{n+2}(ne)\Bigr]^2 + \frac{4}{3n^2}\Bigl[J_n(ne)\Bigr]^2 \Biggr).
        \end{split}
        \end{equation}
        The GW spectral strain amplitude at a given harmonic can be related to the (rest-frame) luminosity as \citep[][Eq.~2.1]{Finn+Thorne-2000},
        \begin{subequations}
        \label{eq:strain_lum}
        \begin{align}
            \hsn^2 & = \frac{G}{c^3} \, \scale[2]{2}{n} \, \frac{\lgwn}{\lr[2]{2 \pi \, \frstorb} \, \distcom^2}, \\
                & = \frac{32}{5 c^8} \, \scale[2]{2}{n} \, \frac{\left(G\mchirp\right)^{10/3}}{\distcom^2} \lr[4/3]{2\pi\frstorb} \cdot g(n,e).
        \end{align}
        \end{subequations}
        We always take the chirp mass to be an intrinsic (rest-frame) property of the binary, however an `observer-frame' chirp-mass can also be used.  For example, in the case of a circular binary, the spectral strain is,
        \begin{equation}
            \label{eq:gw_strain_amp_circ}
            \hscirc
                = \frac{8}{10^{1/2}} \frac{\left(G\mchirp\right)^{5/3}}{c^4 \, \distcom} \left(2 \pi \frstorb \right)^{2/3}
                = \frac{8}{10^{1/2}} \frac{\left(G\mchirp_o\right)^{5/3}}{c^4 \, \distlum} \left(2 \pi \fobsorb \right)^{2/3}.
        \end{equation}

        \todo{The spectral strain can be related to characteristic strain as...}

        Instead of characteristic strain, the GWB spectrum at low-frequencies is often characterized in terms of the power spectral density (PSD) of timing residuals\footnote{The PSD is often denoted by $S_h$ in the GW literature.  Unfortunately, the PSD of GW strain is also often used and referred to using the same symbols and terminology, while the physical quantity is quite distinct \needcite{}.} ($\psd$)
        \begin{equation}
            \label{eq:psd_char_strain}
            \psd(f) = \frac{\hc^2(f)}{12 \pi^2 f^3}.
        \end{equation}
        Assuming a power-law form for the PSD gives an expression analogous to Eq.~\ref{eq:char_strain_plaw}
        \begin{equation}
            \label{eq:psd_char_strain}
            \psd(f) \approx  A^2_\tr{ref} \cdot \scale[\gamma]{\fobs}{\fref} \scale[-3]{f}{\fref},
        \end{equation}
        such that the PSD spectral index is related to the characteristic strain spectral index as, $\gamma = 2 \alpha - 3$.  In terms of PSD, the idealized, circular, GW-only GWB power-law index is then $\gamma = -13/3$.  Note that the literature uses varying sign conventions for both $\alpha$ and $\gamma$ such that they may typically be positive or negative.


    \subsection{Cosmology}
        Some useful cosmographic relations are reproduced here \citep{Hogg-1999}.  Recall that luminosity distance and comoving distance are related as $\distlum = (1+z) \distcom$.  The differential comoving volume of the Universe is,
        \begin{equation}
            \label{eq:comvol}
            \frac{d V_c}{dz} = 4\pi \, d_c^2 \, \frac{c}{H(z)},
        \end{equation}
        and time (or age of the universe) can be related to redshift through,
        \begin{align}
            \label{eq:redshift_time}
            \frac{dz}{dt} = \lr{1+z} \; H(z).
        \end{align}
        The Hubble parameter can be calculated from the matter-energy constituents of the universe as,
        \begin{align}
            H(z) & = H_0(z) \cdot \lrs[1/2]{\Omega_R \lr[4]{1+z} + \Omega_m \lr[3]{1+z} + \Omega_k \lr[2]{1+z} + \Omega_\Lambda}.
        \end{align}
        The $\Omega$ terms are the usual redshift-zero fractions of the critical density for radiation, non-relativistic matter, curvature, and dark energy.  We adopt the results of WMAP9 \citep{Hinshaw+2013} for our fiducial cosmology, assuming zero curvature: $H_0 = 69.33 \textrm{ km/s/Mpc}$, $\Omega_m = 0.2880$, $\Omega_\Lambda = 0.7120$.



\section{Additional Material}
    \label{sec:app}

    \noindent\begin{minipage}{\linewidth}

        % Fig -
        % \centering
        % \includegraphics[width=0.55\columnwidth]{{{figs/doan+2019_jitter}}}
        % \captionof{figure}{Distribution of velocity-offset variations (`jitters') from \citep{Doan+2019}, for the red and blue components of the observed BLs.  Measurements are shown as ticks at $y=0$, and KDE distributions are shown using a Scott's factor bandwidth, and Gaussian kernel.  The purple curve is the KDE distribution taking both red and blue data as independent.  The KDE $50\%$ (median) and $99\%$ (Gaussian standard deviation $\sigma \approx 2.3$) jitter for each component are shown with dashed vertical lines and corresponding labels.}
        % \label{fig:jitter_doan2019}
        %
        % \setlength{\tabcolsep}{8pt}
        % \begin{tabular}{p{1.5cm} c c c c c c c}
        %      & & & $5\%$ & $25\%$ & $50\%$ & $75\%$ & $95\%$ \\ [0.5ex]
        %     \hline
        %     \multirow{4}{*}{All}  & \multirow{4}{*}{-}
        %         & $M \; [M_\odot]$ & $3.4 \times10^{ 6 }$ & $7.2 \times10^{ 6 }$ & $1.8 \times10^{ 7 }$ & $6.0 \times10^{ 7 }$ & $4.1 \times10^{ 8 }$ \\
        %         & & q & $2.9 \times10^{ -2 }$ & $1.7 \times10^{ -1 }$ & $4.0 \times10^{ -1 }$ & $6.8 \times10^{ -1 }$ & $9.3 \times10^{ -1 }$ \\
        %         & & z & 0.24 & 0.41 & 0.53 & 0.62 & 0.69 \\
        %         & & $p \; [\mathrm{yr}]$ & $1.4 \times10^{ 2 }$ & $1.5 \times10^{ 3 }$ & $9.6 \times10^{ 3 }$ & $4.0 \times10^{ 4 }$ & $2.0 \times10^{ 5 }$ \\
        %         & & $a \; [\mathrm{pc}]$ & $2.1 \times10^{ -2 }$ & $1.3 \times10^{ -1 }$ & $4.9 \times10^{ -1 }$ & $1.3 \times10^{ 0 }$ & $4.1 \times10^{ 0 }$ \\
        %         & & $a \; [r_g]$ & $1.2 \times10^{ 4 }$ & $1.4 \times10^{ 5 }$ & $4.5 \times10^{ 5 }$ & $1.2 \times10^{ 6 }$ & $4.1 \times10^{ 6 }$ \\
        %     \hline
        %     \multirow{4}{1.5cm}{Secondary\newline Offset\newline($\voff$)} & \multirow{4}{*}{$0.49\%$}
        %         & $M \; [M_\odot]$ & $1.4 \times10^{ 8 }$ & $4.0 \times10^{ 8 }$ & $7.6 \times10^{ 8 }$ & $1.4 \times10^{ 9 }$ & $3.7 \times10^{ 9 }$ \\
        %         & & q & $9.6 \times10^{ -4 }$ & $4.2 \times10^{ -3 }$ & $1.2 \times10^{ -2 }$ & $3.6 \times10^{ -2 }$ & $1.5 \times10^{ -1 }$ \\
        %         & & z & 0.25 & 0.42 & 0.54 & 0.63 & 0.69 \\
        %         & & $p \; [\mathrm{yr}]$ & $8.3 \times10^{ 2 }$ & $1.5 \times10^{ 3 }$ & $2.3 \times10^{ 3 }$ & $3.7 \times10^{ 3 }$ & $9.0 \times10^{ 3 }$ \\
        %         & & $a \; [\mathrm{pc}]$ & 0.22 & 0.41 & 0.58 & 0.87 & 1.82 \\
        %         & & $a \; [r_g]$ & $5.0 \times10^{ 3 }$ & $1.1 \times10^{ 4 }$ & $1.8 \times10^{ 4 }$ & $2.9 \times10^{ 4 }$ & $4.9 \times10^{ 4 }$ \\
        % \end{tabular}
        % \captionof{table}{\textbf{Parameters of detectable binary systems with redshift $z < 0.7$.}  The indicated quantiles are given for total mass ($M$), mass ratio ($q$), separation ($a$), and orbital period ($p$).  In only four binaries ($2\E{-8}$ of systems) is the primary detectable, and those have parameters: \mbox{$M\approx 2$--$5\E{9} \, \msol$},
        % \hspace{0.5ex} \mbox{$q \approx 0.7$--$0.9$}, \hspace{0.5ex} \mbox{$z \approx 0.6$--$0.8$}, \hspace{0.5ex} \mbox{$a \approx 2.2$--$2.8 \, \pc$}.}
        % \label{tab:obs_pars}

    \end{minipage}

\twocolumn


\end{document}
