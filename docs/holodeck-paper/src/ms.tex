% =================================================================================================
% Holodeck Paper Manuscript
% -------------------------
%
%
%
% =================================================================================================

% general package imports and setup
\input{packages}
% definitions of custom commands
\input{commands}
% journal abbreviations for bibliography
\input{abbrevs}

% =================================================================================================
% ====    Front Matter
% =================================================================================================

\newtotcounter{citnum} % From the package documentation
\def\oldbibitem{} \let\oldbibitem=\bibitem
\def\bibitem{\stepcounter{citnum}\oldbibitem}

\newcommand{\orcidauthorA}{0000-0002-6625-6450} % For author A

\title[Short Title]{Very long and verbose title}
\author[NANOGrav]{the NANOGrav collaboration}
% \author[L.Z.~Kelley et al.]{
%     Luke Zoltan Kelley$^{1}$\thanks{E-mail:lzkelley@northwestern.edu}\orcidA{} \\
%     $^{1}$ \begin{minipage}[t]{\linewidth} Center for Interdisciplinary Exploration and Research in Astrophysics (CIERA), and\\Department of Physics \& Astronomy, Northwestern University, Evanston, IL 60208
%     \end{minipage}
% }


\begin{document}

\maketitle

\begin{abstract}
    abstract
\end{abstract}

\begin{keywords}
    quasars: supermassive black holes
\end{keywords}


% =================================================================================================
% ====    Section 1 - Introduction
% =================================================================================================

\begin{itemize}
    \item Change $f_r \rightarrow f$
    \item holodeck uses $f_\trt{obs}$ as grid variable, not $f_r$, mesh this with the analytic formalism and description
\end{itemize}


\section{Introduction}
    \label{sec:intro}



% =================================================================================================
% ====    Section 2 - Methods
% =================================================================================================

\section{Methods}
    \label{sec:meth}

    \input{sam_text}

    % % Fig -
    % \begin{figure}
    %     \centering
    %     \includegraphics[width=1\columnwidth]{{{example-image-c}}}
    %     \caption{\textbf{header.} body.}
    %     \label{fig:fig1}
    % \end{figure}
    %
    %
    % \begin{equation}\begin{split}
    %     \label{eq:eq1}
    %     2+2 & = 4 \\
    %         & = 10 - 6
    % \end{split}\end{equation}
    %
    % % Fig -
    % \begin{figure*}
	% 	\centering
    %     \subfloat[first]{{
    %         \includegraphics[width=1.75\columnwidth]{{{example-image-a}}}
    %     }}
	% 	\\
    %     % \qquad
    %     \subfloat[second]{{
    %     	\includegraphics[width=1.75\columnwidth]{{{example-image-b}}}
    %     }}
    %     \caption{\textbf{Head.}  Body.}
    %     \label{fig:fig2}
    % \end{figure*}


\section{Implementation}
    \label{sec:imp}

    The \holodeck{} framework is written primarily in \python{} using a class-based structure for modularity and extensibility.

    \subsection{Semi-Analytic Models}
        \label{sec:imp_sam}

        The core of the semi-analytic modeling framework in \holodeck{} is implementing \eqref{eq:sam_final}.  There are classes for each of the key components: The galaxy stellar-mass function (GSMF, $\Phi$), the galaxy pair fraction \(F\), the merger timescale ($\tau$), and additional a scaling relation for mapping host galaxies via to MBH properties --- typically via an \mmbulge{} relation.  Each component class is implemented generically via basic API methods (e.g.~a GSMF that returns the number density of galaxies at a given stellar-mass and redshift), and can be subclassed to provide a particular implementation (e.g.~an analytic Schechter-function GSMF).  The number (or number density) of binaries is specified over a grid of parameters, typically in a four dimensional space of total mass ($M$), mass ratio ($q$), redshift ($z$), and binary rest-frame orbital frequency ($f_r$).

        The semi-analytic model formalism defines a continuous distribution of MBH binaries.  For many calculations, the discrete nature of MBHB sources is important, not only for examining individual continuous wave sources but also because of the important effects of discrete sources on the shape of the GWB due to the non-linear scaling of GW strain \citep{Sesana+2008}.  Additional, a component of the uncertainty in expected GW signals is due to `cosmic variance', which can be treated as Poisson noise when creating multiple samples (or `realizations') of our binary populations.  To handle discretization and resampling we use the \texttt{kalepy} package \citep{kalepy2021}, in particular, a method of outlier sampling to capture regions of parameter space where finite number effects are important.  The \holodeck{} semi-analytic models specify the number (or number-density) of binaries over a grid, i.e.~$N_{ijkl}$.  By definition, grid cells which have an expected total number of binaries $\gg 1$ will not produce appreciable finite-number effects, so instead they are given a weighting based on a Poisson distribution centered around their expectation value, i.e.~$\mathcal{P}(N_{ijkl})$.  Grid cells with expected numbers of order unity or less do produce important finite-number effects, and thus are directly resampled

% =================================================================================================
% ====    Section 3 - Results
% =================================================================================================
\section{Results}
    \label{sec:res}

    % Fig -
    % \begin{figure*}
    %     \centering
    %     \includegraphics[width=1.5\columnwidth]{{{figs/det-nums_fedd-1.00_voff+3.00_dvel+2.00_tobs+0.70}}}
    %     \caption{\textbf{Distributions of parameters for all binaries (black) and those with a detectable kinematic signature in the secondary AGN (colors).}  Less than $10^{-7}$ of primaries are observable, which are not shown.  Secondary AGN with observable velocity offsets ($\voff$) are shown in blue assuming a sensitivity of \mbox{$\voffsens = 10^3 \kmps$}.  Secondaries with observable changing velocities ($\dvel$) are shown in orange (solid) for a sensitivity $\dvelsens = 10^2 \kmps$, and observing baseline of \mbox{$\tobs = 5\, \yr$}.  Systems where both offsets and changes are detectable (orange, dotted) are mostly a uniform subset of the $\dvel$ sample, and are almost indistinguishable in the 2D contour plots.  An optical flux cutoff of \mbox{$6\E{-14} \mathrm{erg/s/cm}^2$} (AB Mag $\approx 21$) is also imposed, where all AGN are assumed to be accreting at an Eddington fraction of $0.1$.}
    %     \label{fig:det_bins_num}
    % \end{figure*}



% =================================================================================================
% ====    Section 4 - Conclusions
% =================================================================================================
\section{Discussion \& Conclusions}
    \label{sec:disc}



% =================================================================================================
% ====    End Matter
% =================================================================================================


% ====    Acknowledgments

\section*{Acknowledgments}
	I am very thankful to.

    This research made use of \texttt{astropy}, a community-developed core Python package for Astronomy \citep{astropy2013}, in addition to \texttt{Scipy}~\citep{scipy}, \texttt{ipython}~\citep{ipython}, \texttt{jupyter}~notebook~\citep{jupyter}, \texttt{Numpy}~\citep{numpy2011} \& \texttt{SymPy}~\citep{sympy2017}.  All figures were generated using \texttt{matplotlib}~\citep{matplotlib2007}.  Kernel density estimation was performed using the \texttt{kalepy}{} package (\href{https://github.com/lzkelley/kalepy}{github.com/lzkelley/kalepy}) \citep{kalepy2020}.

    The Illustris data is available online at \href{https://www.illustris-project.org/}{www.illustris-project.org} \citep{Nelson+2015}, and Illustris-TNG data at \href{https://www.tng-project.org/}{www.tng-project.org} \citep{Nelson+2019}.


% ====    Bibliography

\let\oldUrl\url
\renewcommand{\url}[1]{\href{#1}{Link}}

\quad{}
\bibliographystyle{mnras}
\bibliography{refs}

\onecolumn
\clearpage


% ====    Appendices

\appendix

    \section{Additional Equations}
        \label{sec:app_eqs}
        A binary is described by its total mass $M$, mass ratio $q \equiv m_2 / m_1$ (s.t.~$q\leq1$), (proper) semi-major axis $a$, and rest-frame orbital frequency $f_r$.  The characteristic gravitational wave mass is the chirp mass, $\mchirp \equiv M \, q^{3/5} \, \lr[-6/5]{1+q}$.

        The GW strain from a circular binary is \citep[][Eq.~7; sky and polarization averaged]{Sesana+2008},
            \begin{equation}
            \label{eq:source_strain}
            h_s = \frac{8}{10^{1/2}} \frac{\left(G\mchirp\right)^{5/3}}{c^4 \, d_L}
                \left(2 \pi f_r \right)^{2/3},
            \end{equation}
        for a luminosity distance $d_L$.  Recall that the luminosity distance and comoving distance are related as $d_L = d_c \, (1+z)$, that the comoving volume of the Universe is given by \citep{Hogg-1999},
        \begin{equation}
            \frac{d V_c}{dz} = 4\pi \frac{c}{H_0} \frac{d_c^2}{E(z)},
        \end{equation}
        and that redshift can be related to time (or age of the universe) as,
        \begin{align}
            \frac{dz}{dt} = H_0 \lr{1+z} E(z).
        \end{align}
        The evolution of the Hubble parameter over redshift can be calculated from the matter-energy constituents of the universe as,
        \begin{align}
            H(z) & = H_0(z) E(z), \\
            E(z) & \equiv \lrs[1/2]{\Omega_R \lr[4]{1+z} + \Omega_m \lr[3]{1+z} + \Omega_k \lr[2]{1+z} + \Omega_\Lambda}.
        \end{align}
        The $\Omega$ terms are the usual redshift-zero fractions of the critical density for radiation, non-relativistic matter, curvature, and dark energy.  We adopt the results of WMAP9 \citep{Hinshaw+2013} for our fiducial cosmology, assuming zero curvature: $H_0 = 69.33 \textrm{ km/s/Mpc}$, $\Omega_m = 0.2880$, $\Omega_\Lambda = 0.7120$.

    \section{Additional Material}
        \label{sec:app}

        \noindent\begin{minipage}{\linewidth}

            % Fig -
            % \centering
            % \includegraphics[width=0.55\columnwidth]{{{figs/doan+2019_jitter}}}
            % \captionof{figure}{Distribution of velocity-offset variations (`jitters') from \citep{Doan+2019}, for the red and blue components of the observed BLs.  Measurements are shown as ticks at $y=0$, and KDE distributions are shown using a Scott's factor bandwidth, and Gaussian kernel.  The purple curve is the KDE distribution taking both red and blue data as independent.  The KDE $50\%$ (median) and $99\%$ (Gaussian standard deviation $\sigma \approx 2.3$) jitter for each component are shown with dashed vertical lines and corresponding labels.}
            % \label{fig:jitter_doan2019}
			%
            % \setlength{\tabcolsep}{8pt}
            % \begin{tabular}{p{1.5cm} c c c c c c c}
            %      & & & $5\%$ & $25\%$ & $50\%$ & $75\%$ & $95\%$ \\ [0.5ex]
            %     \hline
            %     \multirow{4}{*}{All}  & \multirow{4}{*}{-}
            %         & $M \; [M_\odot]$ & $3.4 \times10^{ 6 }$ & $7.2 \times10^{ 6 }$ & $1.8 \times10^{ 7 }$ & $6.0 \times10^{ 7 }$ & $4.1 \times10^{ 8 }$ \\
            %         & & q & $2.9 \times10^{ -2 }$ & $1.7 \times10^{ -1 }$ & $4.0 \times10^{ -1 }$ & $6.8 \times10^{ -1 }$ & $9.3 \times10^{ -1 }$ \\
            %         & & z & 0.24 & 0.41 & 0.53 & 0.62 & 0.69 \\
            %         & & $p \; [\mathrm{yr}]$ & $1.4 \times10^{ 2 }$ & $1.5 \times10^{ 3 }$ & $9.6 \times10^{ 3 }$ & $4.0 \times10^{ 4 }$ & $2.0 \times10^{ 5 }$ \\
            %         & & $a \; [\mathrm{pc}]$ & $2.1 \times10^{ -2 }$ & $1.3 \times10^{ -1 }$ & $4.9 \times10^{ -1 }$ & $1.3 \times10^{ 0 }$ & $4.1 \times10^{ 0 }$ \\
            %         & & $a \; [r_g]$ & $1.2 \times10^{ 4 }$ & $1.4 \times10^{ 5 }$ & $4.5 \times10^{ 5 }$ & $1.2 \times10^{ 6 }$ & $4.1 \times10^{ 6 }$ \\
            %     \hline
            %     \multirow{4}{1.5cm}{Secondary\newline Offset\newline($\voff$)} & \multirow{4}{*}{$0.49\%$}
            %         & $M \; [M_\odot]$ & $1.4 \times10^{ 8 }$ & $4.0 \times10^{ 8 }$ & $7.6 \times10^{ 8 }$ & $1.4 \times10^{ 9 }$ & $3.7 \times10^{ 9 }$ \\
            %         & & q & $9.6 \times10^{ -4 }$ & $4.2 \times10^{ -3 }$ & $1.2 \times10^{ -2 }$ & $3.6 \times10^{ -2 }$ & $1.5 \times10^{ -1 }$ \\
            %         & & z & 0.25 & 0.42 & 0.54 & 0.63 & 0.69 \\
            %         & & $p \; [\mathrm{yr}]$ & $8.3 \times10^{ 2 }$ & $1.5 \times10^{ 3 }$ & $2.3 \times10^{ 3 }$ & $3.7 \times10^{ 3 }$ & $9.0 \times10^{ 3 }$ \\
            %         & & $a \; [\mathrm{pc}]$ & 0.22 & 0.41 & 0.58 & 0.87 & 1.82 \\
            %         & & $a \; [r_g]$ & $5.0 \times10^{ 3 }$ & $1.1 \times10^{ 4 }$ & $1.8 \times10^{ 4 }$ & $2.9 \times10^{ 4 }$ & $4.9 \times10^{ 4 }$ \\
            % \end{tabular}
            % \captionof{table}{\textbf{Parameters of detectable binary systems with redshift $z < 0.7$.}  The indicated quantiles are given for total mass ($M$), mass ratio ($q$), separation ($a$), and orbital period ($p$).  In only four binaries ($2\E{-8}$ of systems) is the primary detectable, and those have parameters: \mbox{$M\approx 2$--$5\E{9} \, \msol$},
            % \hspace{0.5ex} \mbox{$q \approx 0.7$--$0.9$}, \hspace{0.5ex} \mbox{$z \approx 0.6$--$0.8$}, \hspace{0.5ex} \mbox{$a \approx 2.2$--$2.8 \, \pc$}.}
            % \label{tab:obs_pars}

        \end{minipage}

    \twocolumn


\end{document}
